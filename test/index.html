<!DOCTYPE html>
<html><head>
  <title>MetaScript Lab 1</title>
  <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="../metascript.js"></script>
  <style type="text/css">
    body {
      font-family: sans-serif;
    }
    #source, #output, pre {
      font-family: Consolas,monospace;
      font-size: 1em;
    }
    #source, #output {
      vertical-align: top;
      display: block;
      min-height: 10em;
      padding: 0.5em;
      margin: 0.5em 0;
      box-sizing: border-box;
      -webkit-box-sizing:border-box;
      -moz-box-sizing: border-box;
    }
    #source {
      border: 1px solid #c0c0c0;
      background-color: #f0f0f0;
      width: 100%;
    }
    .pretty_c { color: #808080; }
    .pretty_t_string, .pretty_t_mstring { color: #008000; font-weight: bold; }
    .pretty_t_keyword { color: #000080; font-weight: bold; }
    .pretty_t_ident, .pretty_t_qident { color: #800080; font-weight: bold; }
    .pretty_t_decimal, .pretty_t_hex { color: #0000ff; }
    .pretty_s_semi { background-color: #e0ffe0; }
  </style>
</head><body>

<h3>Semicolon inference</h3>

<p>
<ul>
<li>The first non-introductory token in a braces-delimited scope or the global scope sets the scope's base indentation. The introduction may be a comma-separated list of identifiers followed by "=>".</li>
<li>If the base indentation has been defined and a new line is encountered inside the block, insert a semicolon before the new line if the following conditions are met:
  <ul>
  <li>The first non-whitespace, non-comment token on the new line is not indented further then the base indentation</li>
  <li>That token is not "else", ";", "{", "}" or the end of the input</li>
  <li>The previous non-whitespace, non-comment token is not ";", "{", "}", "=>" or the beginning of the input</li>
  </ul>
</li>
</ul>
</p>

<textarea id="source">
/* Semicolon inference test */

function f() {
  a
  b
    b2
    b3
  function g() {
    c
      c1
  }
  function h()
  {
    i
  }
  e
    e1
      e2 { p, q =>
        k
        l
          l1
      }
      e3
  if(m) n
  else { o
           o1
    p }
  j
}

</textarea>

<button id="prettyprint">Pretty-Print</button>
<hr />
<pre id="pretty"></pre>
<hr />
<pre id="output"></pre>

<script type="text/javascript">
  var ms = MetaScriptFactory();
  var output = $("#output");
  ms.log = function(msg) { output.append(msg+"\r\n"); };

  function prettyPrint() {
    output.html("");
    var source = $("#source").attr("value");
    var start = ms.tokenize(source);
    ms.log(start.showAll());
    ms.log(start.showAll(true));
    if(start.error) ms.log("Tokenization error: " + start.error + "; Rest: " + start.rest);
    else {
      start = ms.insertVirtualSemicolons(start);
      if(start.error) ms.log("Layout error: " + start.error + "; Rest: " + start.rest);
      else {
        $("#pretty").html(start.toPrettyHTML({ vsemi: true }));
      }
    }
    ms.log("Finished");
  }

  function print(msg) { $("#output").append(msg); }
  function println(msg) { print(msg+"\r\n"); }

  $(function() {
    $("#prettyprint").click(prettyPrint);
    prettyPrint();
  });
</script>

</body></html>
